# System Architecture

## Clean Architecture Overview

The United Tactical Defense system follows the clean architecture pattern, which consists of the following layers:

### Core Layer
- Contains domain entities and business rules
- Defines interfaces for outer layers
- Has no dependencies on other layers
- Components:
  - Entities: Domain models that represent business objects
  - Interfaces: Contracts that outer layers must implement
  - Use Cases: Business logic and operations

### Service Layer
- Contains implementation of business logic
- Depends only on the Core layer
- Implements interfaces defined in the Core layer
- Components:
  - Service implementations
  - Business logic operations
  - Orchestration of multiple operations
  - Adapters: Convert between external and internal data formats

### Data Access Layer
- Contains database and external service access
- Implements repository interfaces from Core layer
- Handles data persistence and retrieval
- Components:
  - Repository implementations
  - Data models and schemas
  - Database connections and operations

### API Layer
- Contains HTTP endpoints and controllers
- Handles request validation and response formatting
- Depends on Service layer for business logic
- Components:
  - Controllers: Handle HTTP requests
  - Middleware: Process requests and responses
  - Routes: Define API endpoints
  - Validators: Validate input data

## Directory Structure
/src
/core
/entities       # Domain models
/interfaces     # Contracts for repositories and services
/adapters      # Interfaces for data adapters
/usecases       # Business logic operations
/api
/controllers    # API endpoint controllers
/middleware     # Request processing middleware
/validators     # Input validation modules
/routes         # Route definitions
/services
/auth           # Authentication services
/lead           # Lead management services
/appointment    # Appointment scheduling services
/form           # Form processing services
  /adapters     # Form data format adapters
/data
/models         # Data models and schemas
/repositories   # Data access repositories
/migrations     # Database migration scripts
/config           # Configuration management
/utils            # Utility functions and helpers

## Component Interactions

### Authentication Flow
1. Client sends credentials to /api/auth/login
2. AuthController validates input using validation middleware
3. AuthService authenticates user via UserRepository
4. JWT token is generated and returned to client
5. Subsequent requests use token in Authorization header
6. AuthMiddleware verifies token and attaches user to request

### Lead Management Flow
1. LeadController receives lead creation request
2. Input is validated by validation middleware
3. LeadService processes the lead creation
4. LeadRepository saves to database
5. Events are published via EventSystem

### Appointment Scheduling Flow
1. AppointmentController receives appointment request
2. Validation middleware validates input
3. AppointmentService checks availability via Repository
4. If available, appointment is created via Repository
5. Confirmation is sent back to client
6. Lead is updated with appointment information

### Form Processing Flow
1. FormController receives form submission request
2. Input is validated against form-specific validation rules
3. FormService processes the submission based on form type
4. Form is saved to database via FormRepository
5. Form can be converted to other entities (e.g., Lead)
6. Processing result is returned to client

### External Form Submission Flow
1. FormController receives external form submission
2. Form adapter converts external data to internal format
3. External data is validated using adapter-specific validation
4. FormService processes the submission using the converted data
5. If configured, data is forwarded to external systems
6. Processing result is returned to client

## Core Components

### Authentication System
- Handles user registration and login
- Implements JWT-based authentication
- Provides role-based authorization
- Manages user sessions and token refresh

### Lead Management System
- Processes and stores lead information
- Manages lead status and assignment
- Provides search and filtering capabilities
- Tracks lead activities and conversion

### Appointment System
- Handles scheduling, rescheduling, and cancellation of appointments
- Manages availability through time slot management
- Integrates with lead management system
- Provides calendar views and appointment filtering
- Sends notifications for upcoming appointments
- Ensures no conflicts or double-bookings occur

### Form Processing System
- Validates and processes form submissions
- Supports multiple form types with different validation rules
- Integrates with lead management system
- Handles data transformation and storage
- Provides submission tracking and management
- Allows form submissions to be converted to leads or appointments
- Supports external form submissions through adapters
- Can forward submissions to external systems

### Analytics Engine
- Tracks user interactions and events
- Generates reports and insights
- Identifies trends and patterns
- Provides dashboard data

## Middleware Components

### Authentication Middleware
- Verifies JWT tokens in request headers
- Extracts user information from tokens
- Provides role-based authorization
- Secures protected routes

### Error Handling Middleware
- Handles all application errors
- Formats error responses in consistent format
- Provides detailed error information in development
- Logs errors for debugging and monitoring

### Request Logging Middleware
- Logs all API requests and responses
- Provides detailed timing information
- Excludes sensitive routes from logging
- Configurable verbosity based on environment

### Validation Middleware
- Validates request data against schemas
- Sanitizes input to prevent security issues
- Provides detailed validation error messages
- Supports custom validation rules for business logic

## Authentication System

### JWT Authentication Flow
1. User provides email and password to /api/auth/login
2. AuthController validates credentials via AuthService
3. AuthService authenticates user via UserRepository
4. If authentication is successful:
   - Access token is generated with short expiry (1 day default)
   - Refresh token is generated with longer expiry (7 days default)
   - Both tokens and user data are returned to client
5. Client stores tokens securely
6. Subsequent requests include access token in Authorization header
7. AuthMiddleware verifies token and attaches user to request
8. When access token expires, client uses refresh token to get a new access token
9. The `/api/auth/refresh` endpoint validates refresh token and issues new access token

### Token Security
- Access tokens have short lifetime to mitigate security risks
- Refresh tokens have longer lifetime but can only be used to generate new access tokens
- Tokens are signed with a secret key to ensure their authenticity
- Tokens contain minimal user data (id, email, role) to reduce payload size
- Token validation is performed on every protected route

### User Registration Flow
1. User submits registration data to /api/auth/register
2. AuthController validates input using validation middleware
3. AuthService checks if user already exists
4. If user doesn't exist:
   - Password is securely hashed using PBKDF2 algorithm
   - User entity is created and saved to database via UserRepository
   - Access token and refresh token are generated
   - Tokens and user data are returned to client

### User Entities and Interfaces
- User Entity: Represents user domain object with validation logic
- UserRepository: Handles data access for user operations
- AuthService: Provides authentication business logic
- AuthController: Handles HTTP requests for authentication
- AuthMiddleware: Verifies tokens and secures protected routes
